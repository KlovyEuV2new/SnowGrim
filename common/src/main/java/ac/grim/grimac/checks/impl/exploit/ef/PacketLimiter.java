package ac.grim.grimac.checks.impl.exploit.ef;

import ac.grim.grimac.checks.Check;
import ac.grim.grimac.checks.CheckData;
import ac.grim.grimac.checks.type.PacketCheck;
import ac.grim.grimac.player.GrimPlayer;
import com.github.retrooper.packetevents.event.PacketReceiveEvent;
import com.github.retrooper.packetevents.protocol.packettype.PacketType;
import com.github.retrooper.packetevents.protocol.packettype.PacketTypeCommon;
import com.github.retrooper.packetevents.protocol.item.ItemStack;
import com.github.retrooper.packetevents.protocol.item.type.ItemType;
import com.github.retrooper.packetevents.protocol.nbt.*;
import com.github.retrooper.packetevents.wrapper.play.client.*;

import java.nio.charset.StandardCharsets;
import java.util.*;

@CheckData(name = "PacketLimiter")
public class PacketLimiter extends Check implements PacketCheck {

    private final long maxSizeBytes = 24 * 1024;
    private final int displayNameLimit = 180;
    private final int loreLimit = 64;
    private final int bookTitleLimit = 16;
    private final int bookAuthorLimit = 16;
    private final int bookPagesLimit = 50;
    private final int bookContentLimit = 300;
    private final int maxSignSize = 47;
    private final int tabCompleteLimit = 256;

    private final boolean maxFlagsEnabled = true;
    private final Map<String, Integer> maxFlagsLimits = new HashMap<>();

    public PacketLimiter(GrimPlayer player) {
        super(player);
        initMaxFlags();
    }

    private void initMaxFlags() {
        maxFlagsLimits.put("total", 96);
        maxFlagsLimits.put("extra", 16);
        maxFlagsLimits.put("translate", 1);
        maxFlagsLimits.put("separator", 48);
        maxFlagsLimits.put("object", 64);
        maxFlagsLimits.put("array", 16);
        maxFlagsLimits.put("translate_placeholder", 1);
        maxFlagsLimits.put("firework", 12);
        maxFlagsLimits.put("firework_effects", 3);
    }

    @Override
    public void onPacketReceive(PacketReceiveEvent event) {
        PacketTypeCommon packetType = event.getPacketType();

        if (packetType == PacketType.Play.Client.CLICK_WINDOW) {
            WrapperPlayClientClickWindow wrapper = new WrapperPlayClientClickWindow(event);
            CheckItemResult result = checkItem(wrapper.getCarriedItemStack());
            if (result != CheckItemResult.VALID_ITEM) {
                cancelAndFlag(event, "Invalid item: " + result.name());
                return;
            }
        } else if (packetType == PacketType.Play.Client.CREATIVE_INVENTORY_ACTION) {
            WrapperPlayClientCreativeInventoryAction wrapper = new WrapperPlayClientCreativeInventoryAction(event);
            CheckItemResult result = checkItem(wrapper.getItemStack());
            if (result != CheckItemResult.VALID_ITEM) {
                cancelAndFlag(event, "Invalid creative item: " + result.name());
                return;
            }
        } else if (packetType == PacketType.Play.Client.EDIT_BOOK) {
            WrapperPlayClientEditBook wrapper = new WrapperPlayClientEditBook(event);
            if (!checkBookPacket(wrapper)) {
                cancelAndFlag(event, "Invalid book data");
                return;
            }
        } else if (packetType == PacketType.Play.Client.UPDATE_SIGN) {
            WrapperPlayClientUpdateSign wrapper = new WrapperPlayClientUpdateSign(event);
            if (!checkSignPacket(wrapper)) {
                cancelAndFlag(event, "Invalid sign data");
                return;
            }
        } else if (packetType == PacketType.Play.Client.TAB_COMPLETE) {
            WrapperPlayClientTabComplete wrapper = new WrapperPlayClientTabComplete(event);
            if (!checkTabComplete(wrapper)) {
                cancelAndFlag(event, "Tab complete text too long");
                return;
            }
        }
    }

    private boolean checkTabComplete(WrapperPlayClientTabComplete wrapper) {
        String text = wrapper.getText();
        return text == null || text.length() <= tabCompleteLimit;
    }

    private boolean checkSignPacket(WrapperPlayClientUpdateSign wrapper) {
        String[] lines = wrapper.getTextLines();
        if (lines == null) return true;

        int totalLength = 0;
        for (String line : lines) {
            if (line != null) {
                totalLength += line.length();
            }
        }
        return totalLength <= maxSignSize;
    }

    private boolean checkBookPacket(WrapperPlayClientEditBook wrapper) {
        int slot = wrapper.getSlot();
        if (slot < 0 || slot > 45) {
            return false;
        }
        return true;
    }

    private CheckItemResult checkItem(ItemStack item) {
        if (item == null || item.isEmpty()) {
            return CheckItemResult.VALID_ITEM;
        }

        try {
            NBTCompound nbt = item.getNBT();
            if (nbt == null) {
                return CheckItemResult.VALID_ITEM;
            }

            NBTCompound display = nbt.getCompoundTagOrNull("display");
            if (display != null) {
                String displayName = display.getStringTagValueOrNull("Name");
                if (displayName != null && displayName.length() > displayNameLimit) {
                    return CheckItemResult.LONG_ITEM_NAME;
                }

                NBT loreTag = display.getTagOrNull("Lore");
                if (loreTag instanceof NBTList) {
                    NBTList<?> lore = (NBTList<?>) loreTag;
                    if (lore.size() > loreLimit) {
                        return CheckItemResult.LONG_ITEM_LORE;
                    }
                }
            }

            ItemType type = item.getType();
            if (type.getName().toString().contains("WRITTEN_BOOK") ||
                    type.getName().toString().contains("WRITABLE_BOOK")) {
                return checkBook(nbt);
            }

            NBTCompound blockEntityTag = nbt.getCompoundTagOrNull("BlockEntityTag");
            if (blockEntityTag != null) {
                CheckItemResult result = checkBlockState(blockEntityTag);
                if (result != CheckItemResult.VALID_ITEM) {
                    return result;
                }
            }

            NBTCompound fireworks = nbt.getCompoundTagOrNull("Fireworks");
            if (fireworks != null) {
                return checkFirework(fireworks);
            }

            if (maxFlagsEnabled) {
                int complexity = calculateNBTComplexity(nbt);
                int maxTotal = maxFlagsLimits.getOrDefault("total", 96);
                if (complexity > maxTotal) {
                    return CheckItemResult.INVALID_NBT_COMPLEXITY;
                }
            }

        } catch (Exception e) {
            return CheckItemResult.INVALID_ITEM;
        }

        return CheckItemResult.VALID_ITEM;
    }

    private CheckItemResult checkBook(NBTCompound nbt) {
        String title = nbt.getStringTagValueOrNull("title");
        if (title != null && title.length() > bookTitleLimit) {
            return CheckItemResult.LONG_BOOK_TITLE;
        }

        String author = nbt.getStringTagValueOrNull("author");
        if (author != null && author.length() > bookAuthorLimit) {
            return CheckItemResult.LONG_BOOK_AUTHOR;
        }

        NBT pagesTag = nbt.getTagOrNull("pages");
        if (pagesTag instanceof NBTList) {
            NBTList<?> pages = (NBTList<?>) pagesTag;
            if (pages.size() > bookPagesLimit) {
                return CheckItemResult.TOO_MANY_BOOK_PAGES;
            }

            for (int i = 0; i < pages.size(); i++) {
                NBT pageTag = pages.getTag(i);
                if (pageTag instanceof NBTString) {
                    String pageContent = ((NBTString) pageTag).getValue();
                    int pageBytes = pageContent.getBytes(StandardCharsets.UTF_8).length;
                    if (pageBytes > bookContentLimit) {
                        return CheckItemResult.LONG_BOOK_CONTENT;
                    }
                }
            }
        }

        return CheckItemResult.VALID_ITEM;
    }

    private CheckItemResult checkBlockState(NBTCompound blockEntityTag) {
        NBT itemsTag = blockEntityTag.getTagOrNull("Items");
        if (itemsTag instanceof NBTList) {
            NBTList<?> items = (NBTList<?>) itemsTag;
            for (int i = 0; i < items.size(); i++) {
                NBT itemTag = items.getTag(i);
                if (itemTag instanceof NBTCompound) {
                    NBTCompound itemNBT = (NBTCompound) itemTag;
                    int complexity = calculateNBTComplexity(itemNBT);
                    if (complexity > maxFlagsLimits.getOrDefault("total", 96)) {
                        return CheckItemResult.INVALID_NBT_COMPLEXITY;
                    }
                }
            }
        }

        return CheckItemResult.VALID_ITEM;
    }

    private CheckItemResult checkFirework(NBTCompound fireworks) {
        NBT flightTag = fireworks.getTagOrNull("Flight");
        if (flightTag instanceof NBTNumber) {
            NBTNumber flight = (NBTNumber) flightTag;
            if (flight.getAsInt() > 3) {
                return CheckItemResult.INVALID_FIREWORK_POWER;
            }
        }

        NBT explosionsTag = fireworks.getTagOrNull("Explosions");
        if (explosionsTag instanceof NBTList) {
            NBTList<?> explosions = (NBTList<?>) explosionsTag;
            int allowedEffects = maxFlagsLimits.getOrDefault("firework_effects", 3);

            if (explosions.size() > allowedEffects) {
                return CheckItemResult.INVALID_FIREWORK_EFFECTS;
            }

            for (int i = 0; i < explosions.size(); i++) {
                NBT explosionTag = explosions.getTag(i);
                if (explosionTag instanceof NBTCompound) {
                    NBTCompound explosion = (NBTCompound) explosionTag;

                    NBT colorsTag = explosion.getTagOrNull("Colors");
                    if (colorsTag instanceof NBTList) {
                        NBTList<?> colors = (NBTList<?>) colorsTag;
                        if (colors.size() > allowedEffects) {
                            return CheckItemResult.INVALID_FIREWORK_COLORS;
                        }
                    }

                    NBT fadeColorsTag = explosion.getTagOrNull("FadeColors");
                    if (fadeColorsTag instanceof NBTList) {
                        NBTList<?> fadeColors = (NBTList<?>) fadeColorsTag;
                        if (fadeColors.size() > allowedEffects) {
                            return CheckItemResult.INVALID_FIREWORK_FADE_COLORS;
                        }
                    }
                }
            }
        }

        return CheckItemResult.VALID_ITEM;
    }

    private int calculateNBTComplexity(NBT nbt) {
        return calculateNBTComplexity(nbt, 0);
    }

    private int calculateNBTComplexity(NBT nbt, int depth) {
        if (nbt == null || depth > 10) {
            return 0;
        }

        int complexity = 1;

        if (nbt instanceof NBTCompound) {
            NBTCompound compound = (NBTCompound) nbt;
            for (String key : compound.getTags().keySet()) {
                complexity += calculateNBTComplexity(compound.getTags().get(key), depth + 1);
            }
        } else if (nbt instanceof NBTList) {
            NBTList<?> list = (NBTList<?>) nbt;
            for (int i = 0; i < list.size(); i++) {
                complexity += calculateNBTComplexity(list.getTag(i), depth + 1);
            }
        }

        return complexity;
    }

    private void cancelAndFlag(PacketReceiveEvent event, String reason) {
        if (shouldModifyPackets()) {
            event.setCancelled(true);
            player.onPacketCancel();
        }
        flagAndAlert(reason);
    }

    public enum CheckItemResult {
        VALID_ITEM,
        INVALID_ITEM,
        LONG_ITEM_NAME,
        LONG_ITEM_LORE,
        LONG_BOOK_TITLE,
        LONG_BOOK_AUTHOR,
        TOO_MANY_BOOK_PAGES,
        LONG_BOOK_CONTENT,
        INVALID_FIREWORK_POWER,
        INVALID_FIREWORK_EFFECTS,
        INVALID_FIREWORK_COLORS,
        INVALID_FIREWORK_FADE_COLORS,
        INVALID_NBT_COMPLEXITY
    }
}
